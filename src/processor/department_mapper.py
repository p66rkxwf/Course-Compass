"""科系映射工具 - 從開課班別字串中擷取學院、科系、年級與班級資訊"""

import pandas as pd
from pathlib import Path
from typing import Dict, List, Optional, Tuple, Any
import re
import logging

from config import DICT_DIR
from utils.common import safe_read_csv

class DepartmentMapper:
    def __init__(self):
        self.logger = logging.getLogger(__name__)
        self.special_course_keys = {
            '語文課', '全民國防教育課程', '核心通識', '日外校大學', '夜外校大學', 
            '日外校碩士班', '日外校博士班', '復大學', '歷大學', '產業學士班', 
            '產業碩士班', '教育大數據微學程', '歷史與文化產業學分學程', 
            '性別平權學分學程', '精進中文', '精進英外文'
        }
        self.department_mapping = self._load_department_mapping()

    def _load_department_mapping(self) -> Dict[str, Dict[str, Any]]:
        """載入科系映射數據"""
        mapping_file = DICT_DIR / "department_mapping.csv"
        default_mapping = self._create_default_mapping()

        if not mapping_file.exists():
            self.logger.warning(f"科系映射文件不存在: {mapping_file}，將使用默認映射")
            return default_mapping

        df = safe_read_csv(mapping_file)
        if df is None or df.empty:
            return default_mapping

        csv_mapping = {}
        for _, row in df.iterrows():
            dept_code = str(row.get('開課班別(代表)', '')).strip()
            if dept_code:
                csv_mapping[dept_code] = {
                    '學院': row.get('學院', ''),
                    '科系': row.get('科系', ''),
                    '年級': row.get('年級', ''),
                    '班級': row.get('班級', '')
                }

        # 合併映射：CSV映射優先，然後是默認映射
        merged_mapping = {**default_mapping, **csv_mapping}

        self.logger.info(f"成功載入科系映射：CSV {len(csv_mapping)} 項，默認 {len(default_mapping)} 項，總共 {len(merged_mapping)} 項")
        return merged_mapping

    def _create_default_mapping(self) -> Dict[str, Dict[str, Any]]:
        """創建默認的科系映射"""
        # 基於國立彰化師範大學的實際科系結構
        default_mapping = {
            # 教育學院
            '輔導與諮商學系': {'學院': '教育學院', '科系': '輔導與諮商學系'},
            '輔': {'學院': '教育學院', '科系': '輔導與諮商學系'},
            '輔導': {'學院': '教育學院', '科系': '輔導與諮商學系'},
            '輔導與諮商': {'學院': '教育學院', '科系': '輔導與諮商學系'},
            '特殊教育學系': {'學院': '教育學院', '科系': '特殊教育學系'},
            '特': {'學院': '教育學院', '科系': '特殊教育學系'},
            '特殊教育': {'學院': '教育學院', '科系': '特殊教育學系'},
            '教育研究所': {'學院': '教育學院', '科系': '教育研究所'},
            '教': {'學院': '教育學院', '科系': '教育研究所'},
            '教育': {'學院': '教育學院', '科系': '教育研究所'},
            '復健諮商研究所': {'學院': '教育學院', '科系': '復健諮商研究所'},
            '復': {'學院': '教育學院', '科系': '復健諮商研究所'},
            '復健': {'學院': '教育學院', '科系': '復健諮商研究所'},
            '高齡健康促進與照護管理原住民專班': {'學院': '教育學院', '科系': '高齡健康促進與照護管理原住民專班'},
            '高齡': {'學院': '教育學院', '科系': '高齡健康促進與照護管理原住民專班'},

            # 理學院
            '數學系': {'學院': '理學院', '科系': '數學系'},
            '數': {'學院': '理學院', '科系': '數學系'},
            '物理學系': {'學院': '理學院', '科系': '物理學系'},
            '物': {'學院': '理學院', '科系': '物理學系'},
            '化學系': {'學院': '理學院', '科系': '化學系'},
            '化': {'學院': '理學院', '科系': '化學系'},
            '生物學系': {'學院': '理學院', '科系': '生物學系'},
            '生': {'學院': '理學院', '科系': '生物學系'},
            '科學教育研究所': {'學院': '理學院', '科系': '科學教育研究所'},
            '科': {'學院': '理學院', '科系': '科學教育研究所'},
            '光電科技研究所': {'學院': '理學院', '科系': '光電科技研究所'},
            '光': {'學院': '理學院', '科系': '光電科技研究所'},
            '統計資訊研究所': {'學院': '理學院', '科系': '統計資訊研究所'},
            '統資': {'學院': '理學院', '科系': '統計資訊研究所'},
            '材料與生物科技暨科教國際碩士學位學程': {'學院': '理學院', '科系': '材料與生物科技暨科教國際碩士學位學程'},
            '材生': {'學院': '理學院', '科系': '材料與生物科技暨科教國際碩士學位學程'},

            # 科技學院
            '電機與機械科技學系': {'學院': '科技學院', '科系': '電機與機械科技學系'},
            '科技': {'學院': '科技學院', '科系': '電機與機械科技學系'},
            '工教': {'學院': '科技學院', '科系': '電機與機械科技學系'},
            '工': {'學院': '科技學院', '科系': '電機與機械科技學系'},
            '智慧車輛工程學系': {'學院': '科技學院', '科系': '智慧車輛工程學系'},
            '智車': {'學院': '科技學院', '科系': '智慧車輛工程學系'},
            '車輛': {'學院': '科技學院', '科系': '智慧車輛工程學系'},
            '人力資源管理研究所': {'學院': '科技學院', '科系': '人力資源管理研究所'},
            '人管': {'學院': '科技學院', '科系': '人力資源管理研究所'},
            '車輛科技研究所': {'學院': '科技學院', '科系': '車輛科技研究所'},
            '人工智慧科技應用碩士學位學程': {'學院': '科技學院', '科系': '人工智慧科技應用碩士學位學程'},
            'AI': {'學院': '科技學院', '科系': '人工智慧科技應用碩士學位學程'},
            '人工智慧': {'學院': '科技學院', '科系': '人工智慧科技應用碩士學位學程'},
            '技術及職業教育研究所': {'學院': '科技學院', '科系': '技術及職業教育研究所'},
            '技職': {'學院': '科技學院', '科系': '技術及職業教育研究所'},

            # 文學院
            '國文學系': {'學院': '文學院', '科系': '國文學系'},
            '國': {'學院': '文學院', '科系': '國文學系'},
            '英語學系': {'學院': '文學院', '科系': '英語學系'},
            '英': {'學院': '文學院', '科系': '英語學系'},
            '美術學系': {'學院': '文學院', '科系': '美術學系'},
            '美': {'學院': '文學院', '科系': '美術學系'},
            '地理學系': {'學院': '文學院', '科系': '地理學系'},
            '地': {'學院': '文學院', '科系': '地理學系'},
            '科技與兒少英語研究所': {'學院': '文學院', '科系': '科技與兒少英語研究所'},
            '兒英': {'學院': '文學院', '科系': '科技與兒少英語研究所'},
            '翻譯研究所': {'學院': '文學院', '科系': '翻譯研究所'},
            '翻譯': {'學院': '文學院', '科系': '翻譯研究所'},
            '台灣文學研究所': {'學院': '文學院', '科系': '台灣文學研究所'},
            '台文': {'學院': '文學院', '科系': '台灣文學研究所'},
            '歷史學研究所': {'學院': '文學院', '科系': '歷史學研究所'},
            '歷': {'學院': '文學院', '科系': '歷史學研究所'},

            # 工學院
            '機電工程學系': {'學院': '工學院', '科系': '機電工程學系'},
            '機電': {'學院': '工學院', '科系': '機電工程學系'},
            '電機工程學系': {'學院': '工學院', '科系': '電機工程學系'},
            '電機': {'學院': '工學院', '科系': '電機工程學系'},
            '電子工程學系': {'學院': '工學院', '科系': '電子工程學系'},
            '電子': {'學院': '工學院', '科系': '電子工程學系'},
            '資訊工程學系': {'學院': '工學院', '科系': '資訊工程學系'},
            '資工': {'學院': '工學院', '科系': '資訊工程學系'},
            '工學院國際工程碩士學位學程': {'學院': '工學院', '科系': '工學院國際工程碩士學位學程'},
            '工學位': {'學院': '工學院', '科系': '工學院國際工程碩士學位學程'},

            # 管理學院
            '資訊管理學系': {'學院': '管理學院', '科系': '資訊管理學系'},
            '資管': {'學院': '管理學院', '科系': '資訊管理學系'},
            '會計學系': {'學院': '管理學院', '科系': '會計學系'},
            '會': {'學院': '管理學院', '科系': '會計學系'},
            '企業管理學系': {'學院': '管理學院', '科系': '企業管理學系'},
            '企管': {'學院': '管理學院', '科系': '企業管理學系'},
            '財務金融技術學系': {'學院': '管理學院', '科系': '財務金融技術學系'},
            '財金': {'學院': '管理學院', '科系': '財務金融技術學系'},

            # 社會科學暨體育學院
            '運動學系': {'學院': '社會科學暨體育學院', '科系': '運動學系'},
            '運': {'學院': '社會科學暨體育學院', '科系': '運動學系'},
            '運動健康研究所': {'學院': '社會科學暨體育學院', '科系': '運動健康研究所'},
            '運健': {'學院': '社會科學暨體育學院', '科系': '運動健康研究所'},
            '公共事務與公民教育學系': {'學院': '社會科學暨體育學院', '科系': '公共事務與公民教育學系'},
            '公育': {'學院': '社會科學暨體育學院', '科系': '公共事務與公民教育學系'},

            # 特殊課程類型
            '語文課': {'學院': '語文中心', '科系': '語文課程'},
            '全民國防教育課程': {'學院': '軍訓室', '科系': '全民國防教育'},
            '核心通識': {'學院': '通識教育中心', '科系': '核心通識課程'},
            '日外校大學': {'學院': '日間部', '科系': '外校大學課程'},
            '夜外校大學': {'學院': '進修部', '科系': '外校大學課程'},
            '日外校碩士班': {'學院': '日間部', '科系': '外校碩士課程'},
            '日外校博士班': {'學院': '日間部', '科系': '外校博士課程'},
            '復大學': {'學院': '進修推廣部', '科系': '進修學士課程'},
            '歷大學': {'學院': '進修推廣部', '科系': '歷史學習課程'},
            '產業學士班': {'學院': '進修推廣部', '科系': '產業學士班'},
            '產業碩士班': {'學院': '進修推廣部', '科系': '產業碩士班'},
            '教育大數據微學程': {'學院': '教育學院', '科系': '教育大數據微學程'},
            '歷史與文化產業學分學程': {'學院': '文學院', '科系': '歷史與文化產業學分學程'},
            '性別平權學分學程': {'學院': '性別平等教育委員會', '科系': '性別平權學分學程'},
            '精進中文': {'學院': '語文中心', '科系': '中文精進課程'},
            '精進英外文': {'學院': '語文中心', '科系': '英文精進課程'},
        }

        return default_mapping

    def parse_department_info(self, dept_code: str) -> Dict[str, Any]:
        """解析開課班別代碼，提取學院、科系、年級、班級資訊"""
        if pd.isna(dept_code):
            return {
                '學院': '',
                '科系': '',
                '年級': '',
                '班級': ''
            }

        dept_str = str(dept_code).strip()

        # 1. 直接匹配完整科系名稱 (排序關鍵：長度優先，避免部分匹配錯誤)
        sorted_items = sorted(self.department_mapping.items(), key=lambda x: len(x[0]), reverse=True)
        
        for dept_name, info in sorted_items:
            if dept_name in dept_str:
                result = info.copy()
                year, class_info = self._extract_year_and_class(dept_str)
                result['年級'] = year
                
                # 班級預設邏輯：
                # 1. 有識別到班級 -> 使用識別結果
                # 2. 沒識別到班級 且 不是特殊課程 -> 預設甲班
                # 3. 沒識別到班級 且 是特殊課程 -> 空白
                if class_info:
                    result['班級'] = class_info
                elif dept_name not in self.special_course_keys:
                    result['班級'] = '甲班'
                else:
                    result['班級'] = ''
                    
                return result

        # 2. 嘗試模式匹配（處理縮寫）
        result = self._parse_dept_code_pattern(dept_str)
        if result['科系']:
            return result

        # 3. 特殊處理：嘗試從縮寫中推斷科系
        result = self._infer_department_from_abbrev(dept_str)
        if result['科系']:
            return result

        # 4. 如果都無法匹配，返回基本信息 (這裡屬於無法識別的課程，暫不預設甲班，或視需求預設)
        year, class_info = self._extract_year_and_class(dept_str)
        # 針對完全無法識別的，如果沒有班級，暫定為甲班？(通常這裡是非特殊的一般未知系所)
        # 為了保險，這裡也套用預設邏輯
        final_class = class_info if class_info else '甲班'
        
        return {
            '學院': '',
            '科系': dept_str,
            '年級': year,
            '班級': final_class
        }

    def _extract_year_and_class(self, dept_str: str) -> Tuple[str, str]:
        """從部門字符串中提取年級和班級信息"""
        # 常見的年級表示
        year_mapping = {
            '1': '1', '一': '1', '大一': '1', '一年級': '1',
            '2': '2', '二': '2', '大二': '2', '二年級': '2',
            '3': '3', '三': '3', '大三': '3', '三年級': '3',
            '4': '4', '四': '4', '大四': '4', '四年級': '4',
            '5': '5', '五': '5', '大五': '5', '五年級': '5',
            '研': '研究所', '研究': '研究所', '碩': '碩士', '博士': '博士'
        }

        year = ''
        class_info = ''

        # 查找年級信息
        for key, value in year_mapping.items():
            if key in dept_str:
                year = value
                break

        # 查找班級信息 (邏輯修改)
        # 1. 優先檢查中文標識
        if '甲' in dept_str:
            class_info = '甲班'
        elif '乙' in dept_str:
            class_info = '乙班'
        else:
            # 2. 檢查英文標識 (防止誤判，例如 AI 的 A)
            # 規則：數字後面接 A/B，或是 A/B 在字串結尾
            match = re.search(r'(?:[0-9])([A-B])', dept_str)
            if not match:
                 # 檢查字串結尾是否單獨為 A 或 B
                 match = re.search(r'^.*[^a-zA-Z]([A-B])$', dept_str)
                 if not match and re.match(r'^([A-B])$', dept_str): # 字串僅為 "A" 或 "B"
                     match = re.match(r'^([A-B])$', dept_str)

            if match:
                char = match.group(1)
                if char == 'A':
                    class_info = '甲班'
                elif char == 'B':
                    class_info = '乙班'

        return year, class_info

    def _infer_department_from_abbrev(self, dept_str: str) -> Dict[str, Any]:
        """從縮寫中推斷科系信息"""
        year, class_info = self._extract_year_and_class(dept_str)
        clean_str = re.sub(r'[0-9]+', '', dept_str).strip()

        # 縮寫映射
        abbrev_mapping = {
            '資管': {'學院': '管理學院', '科系': '資訊管理學系'},
            '資工': {'學院': '工學院', '科系': '資訊工程學系'},
            '數': {'學院': '理學院', '科系': '數學系'},
            '物': {'學院': '理學院', '科系': '物理學系'},
            '化': {'學院': '理學院', '科系': '化學系'},
            '生': {'學院': '理學院', '科系': '生物學系'},
            '國': {'學院': '文學院', '科系': '國文學系'},
            '英': {'學院': '文學院', '科系': '英語學系'},
            '美': {'學院': '文學院', '科系': '美術學系'},
            '地': {'學院': '文學院', '科系': '地理學系'},
            '機電': {'學院': '工學院', '科系': '機電工程學系'},
            '電機': {'學院': '工學院', '科系': '電機工程學系'},
            '電子': {'學院': '工學院', '科系': '電子工程學系'},
            '會': {'學院': '管理學院', '科系': '會計學系'},
            '企管': {'學院': '管理學院', '科系': '企業管理學系'},
            '財金': {'學院': '管理學院', '科系': '財務金融技術學系'},
            '輔': {'學院': '教育學院', '科系': '輔導與諮商學系'},
            '特': {'學院': '教育學院', '科系': '特殊教育學系'},
            '運': {'學院': '社會科學暨體育學院', '科系': '運動學系'},
            '公育': {'學院': '社會科學暨體育學院', '科系': '公共事務與公民教育學系'},
            '科技': {'學院': '科技學院', '科系': '電機與機械科技學系'},
            '智車': {'學院': '科技學院', '科系': '智慧車輛工程學系'},
            '人管': {'學院': '科技學院', '科系': '人力資源管理研究所'},
            '兒英': {'學院': '文學院', '科系': '科技與兒少英語研究所'},
            '台文': {'學院': '文學院', '科系': '台灣文學研究所'},
            '統資': {'學院': '理學院', '科系': '統計資訊研究所'},
            '光': {'學院': '理學院', '科系': '光電科技研究所'},
            '科': {'學院': '理學院', '科系': '科學教育研究所'},
            '工學位': {'學院': '工學院', '科系': '工學院國際工程碩士學位學程'},
            '運健': {'學院': '社會科學暨體育學院', '科系': '運動健康研究所'},
            '技職': {'學院': '科技學院', '科系': '技術及職業教育研究所'},
            'AI': {'學院': '科技學院', '科系': '人工智慧科技應用碩士學位學程'},
            '歷': {'學院': '文學院', '科系': '歷史學研究所'},
            '復': {'學院': '教育學院', '科系': '復健諮商研究所'},
            '教': {'學院': '教育學院', '科系': '教育研究所'},
            '高齡': {'學院': '教育學院', '科系': '高齡健康促進與照護管理原住民專班'},
            '材生': {'學院': '理學院', '科系': '材料與生物科技暨科教國際碩士學位學程'},
        }

        # 檢查縮寫
        for abbrev, info in abbrev_mapping.items():
            if abbrev in clean_str:
                result = info.copy()
                result['年級'] = year
                # 這裡也要應用預設班級邏輯
                if class_info:
                    result['班級'] = class_info
                else:
                    # 縮寫對應的科系名稱通常是全名，檢查該全名是否為特殊課程
                    full_name = result['科系']
                    if full_name not in self.special_course_keys:
                         result['班級'] = '甲班'
                    else:
                         result['班級'] = ''
                return result

        return {
            '學院': '',
            '科系': '',
            '年級': year,
            '班級': class_info
        }

    def _parse_dept_code_pattern(self, dept_str: str) -> Dict[str, Any]:
        """解析部門代碼模式"""
        year, class_info = self._extract_year_and_class(dept_str)
        clean_dept = re.sub(r'[0-9]+', '', dept_str).strip()
        clean_dept = re.sub(r'[A-C]班?', '', clean_dept) # 移除已經識別的班級字元

        sorted_items = sorted(self.department_mapping.items(), key=lambda x: len(x[0]), reverse=True)

        for dept_name, info in sorted_items:
            if dept_name in clean_dept:
                result = info.copy()
                result['年級'] = year
                
                # 應用預設班級邏輯
                if class_info:
                    result['班級'] = class_info
                elif dept_name not in self.special_course_keys:
                    result['班級'] = '甲班'
                else:
                    result['班級'] = ''
                
                return result

        # 無法匹配的情況
        final_class = class_info if class_info else '甲班'
        return {
            '學院': '',
            '科系': clean_dept if clean_dept else dept_str,
            '年級': year,
            '班級': final_class
        }

    def add_department_info_to_df(self, df: pd.DataFrame) -> pd.DataFrame:
        """為DataFrame添加學院、科系、年級、班級信息"""
        if '開課班別(代表)' not in df.columns:
            self.logger.warning("DataFrame缺少'開課班別(代表)'列，無法添加部門信息")
            return df

        dept_info = df['開課班別(代表)'].apply(self.parse_department_info)
        dept_df = pd.DataFrame(list(dept_info))

        columns_to_add = ['學院', '科系', '年級', '班級']
        df = df.drop(columns=[col for col in columns_to_add if col in df.columns], errors='ignore')
        
        result_df = pd.concat([df, dept_df], axis=1)
        self.logger.info(f"成功添加部門信息，共處理 {len(result_df)} 筆記錄")
        return result_df