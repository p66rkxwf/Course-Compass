<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧選課輔助系統 - Course Master</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container-fluid p-0 h-100 d-flex">
        <aside id="sidebar" class="sidebar bg-white shadow-sm d-flex flex-column" role="navigation" aria-hidden="true">
            <div class="p-4 border-bottom d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-3">
                    <i class="fas fa-graduation-cap text-primary fs-3"></i>
                    <h1 class="h5 mb-0 fw-bold">選課大師</h1>
                </div>
                <button class="btn btn-sm btn-light d-md-none sidebar-toggle" aria-controls="sidebar" aria-expanded="false" onclick="toggleSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <nav class="flex-grow-1 p-3">
                <button onclick="switchTab('tab-schedule'); if(window.innerWidth < 768) toggleSidebar();" class="nav-btn btn w-100 text-start mb-2 active">
                    <i class="far fa-calendar-days me-2"></i> 我的課表
                </button>
                <button onclick="switchTab('tab-recommend'); if(window.innerWidth < 768) toggleSidebar();" class="nav-btn btn w-100 text-start mb-2">
                    <i class="fas fa-wand-magic-sparkles me-2"></i> 智慧推薦
                </button>
                <button onclick="switchTab('tab-history'); if(window.innerWidth < 768) toggleSidebar();" class="nav-btn btn w-100 text-start mb-2">
                    <i class="fas fa-chart-line me-2"></i> 歷年課程
                </button>
                
                <button class="nav-btn w-100 text-start mt-3 border-top pt-3" data-bs-toggle="modal" data-bs-target="#settingsModal">
                    <i class="fas fa-cog me-2"></i> 系統設定
                </button>
                <button class="nav-btn w-100 text-start" data-bs-toggle="modal" data-bs-target="#logicInfoModal">
                    <i class="fas fa-info-circle me-2"></i> 系統說明
                </button>
            </nav>

            <div class="p-3 border-top text-center text-muted small">
                &copy; 2026 Course Master
            </div>
        </aside>

        <main class="flex-grow-1 overflow-auto p-4 position-relative">
            <button class="btn btn-outline-primary d-md-none mb-3 sidebar-toggle" aria-controls="sidebar" aria-expanded="false" onclick="toggleSidebar()">
                <i class="fas fa-bars me-1"></i> 選單
            </button>

            <section id="tab-schedule" class="page-section" data-view="auto">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
                    <div class="mb-3 mb-md-0">
                        <h2 class="h3 fw-bold mb-1">我的學期課表</h2>
                        <p class="text-muted mb-0">一鍵導入班級必選修，輕鬆規劃學期進度</p>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <div class="row g-3 mb-3 pb-3 border-bottom">
                            <div class="col-md-3">
                                <label class="form-label small text-muted fw-bold">學年度</label>
                                <select id="select-year" class="form-select">
                                    <option value="114" selected>114學年度</option>
                                    <option value="113">113學年度</option>
                                    <option value="112">112學年度</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small text-muted fw-bold">學期</label>
                                <select id="select-semester" class="form-select">
                                    <option value="1">第1學期</option>
                                    <option value="2" selected>第2學期</option>
                                </select>
                            </div>
                            <div class="col-md-6 d-flex align-items-end justify-content-md-end">
                                <button id="btn-clear" class="btn btn-outline-danger px-4">
                                    <i class="fas fa-trash-alt me-1"></i> 清空課表
                                </button>
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-6 col-md-3">
                                <label class="form-label small text-muted">1. 學制</label>
                                <select id="select-system-schedule" class="form-select">
                                    <option value="">全部學制</option>
                                </select>
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="form-label small text-muted">2. 部別</label>
                                <select id="select-level-schedule" class="form-select">
                                    <option value="">全部部別</option>
                                </select>
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="form-label small text-muted">3. 學院</label>
                                <select id="select-college-schedule" class="form-select">
                                    <option value="">選擇學院</option>
                                </select>
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="form-label small text-muted">4. 科系</label>
                                <select id="select-department-schedule" class="form-select">
                                    <option value="">選擇科系</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-3 align-items-end">
                            <div class="col-6 col-md-3">
                                <label class="form-label small text-muted">5. 年級</label>
                                <select id="select-grade-schedule" class="form-select">
                                    <option value="">選擇年級</option>
                                </select>
                            </div>
                            <div class="col-6 col-md-5">
                                <label class="form-label small text-muted">6. 班級</label>
                                <select id="select-class-schedule" class="form-select">
                                    <option value="">選擇班級</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-4">
                                <button id="btn-import" class="btn btn-primary w-100 py-2 shadow-sm fw-bold">
                                    <i class="fas fa-file-import me-1"></i> 一鍵導入班級課表
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-body p-0">
                        <div id="schedule-table" class="schedule-container"></div>
                        <div id="schedule-cards" class="schedule-cards d-none p-3"></div>
                    </div>
                </div>

                <div class="card shadow-sm mt-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">已選課程 (<span id="total-credits">0</span> 學分)</h5>
                    </div>
                    <div class="card-body">
                        <div id="selected-courses-list" class="row g-3"></div>
                    </div>
                </div>
            </section>

            <section id="tab-recommend" class="page-section d-none">
                <div class="mb-4">
                    <h2 class="h3 fw-bold mb-1">課程智慧推薦</h2>
                    <p class="text-muted mb-0">三步驟快速找到您的理想課程</p>
                </div>
                
                <div class="row g-4">
                    <div class="col-lg-4">
                        <div class="card shadow-sm h-100 border-0">
                            <div class="card-header bg-primary text-white py-3">
                                <h5 class="mb-0 fs-6 fw-bold"><i class="fas fa-filter me-2"></i>推薦條件</h5>
                            </div>
                            <div class="card-body">
                                
                                <div class="mb-4 border-bottom pb-4">
                                    <label class="form-label fw-bold text-primary small text-uppercase ls-1 mb-3">
                                        <span class="badge bg-primary rounded-pill me-1">1</span> 全校性課程
                                    </label>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary category-btn active text-start" data-category="核心通識">
                                            <i class="fas fa-globe-asia me-2 fa-fw"></i> 核心通識
                                        </button>
                                        <button class="btn btn-outline-primary category-btn text-start" data-category="精進中文">
                                            <i class="fas fa-pen-nib me-2 fa-fw"></i> 精進中文
                                        </button>
                                        <button class="btn btn-outline-primary category-btn text-start" data-category="精進英外文">
                                            <i class="fas fa-language me-2 fa-fw"></i> 精進英外文
                                        </button>
                                        <button class="btn btn-outline-primary category-btn text-start" data-category="教育學程">
                                            <i class="fas fa-chalkboard-teacher me-2 fa-fw"></i> 教育學程
                                        </button>
                                        <button class="btn btn-outline-primary category-btn text-start" data-category="大二體育">
                                            <i class="fas fa-running me-2 fa-fw"></i> 大二體育
                                        </button>
                                        <button class="btn btn-outline-primary category-btn text-start" data-category="大三、四體育">
                                            <i class="fas fa-dumbbell me-2 fa-fw"></i> 大三、四體育
                                        </button>
                                    </div>
                                </div>

                                <div class="mb-4 border-bottom pb-4">
                                    <label class="form-label fw-bold text-primary small text-uppercase ls-1 mb-3">
                                        <span class="badge bg-primary rounded-pill me-1">2</span> 系外選修
                                    </label>
                                    
                                    <div class="bg-light p-3 rounded border">
                                        <button class="btn btn-outline-primary category-btn w-100 text-start mb-3" data-category="系外選修">
                                            <i class="fas fa-compass me-2 fa-fw"></i> 搜尋系外選修
                                        </button>
                                        
                                        <div class="ps-1">
                                            <label class="form-label small text-muted fw-bold mb-2">設定目標系所範圍</label>
                                            <select class="form-select form-select-sm mb-2" id="select-college">
                                                <option value="">全部學院</option>
                                                <option value="教育學院">教育學院</option>
                                                <option value="理學院">理學院</option>
                                                <option value="科技學院">科技學院</option>
                                                <option value="文學院">文學院</option>
                                                <option value="工學院">工學院</option>
                                                <option value="管理學院">管理學院</option>
                                                <option value="社會科學暨體育學院">社體學院</option>
                                            </select>
                                            <select class="form-select form-select-sm mb-2" id="select-dept-recommend">
                                                <option value="">請先選擇學院</option>
                                            </select>
                                            <select class="form-select form-select-sm mb-2" id="select-grade">
                                                <option value="">全部年級</option>
                                                <optgroup label="大學部">
                                                    <option value="大學部|1">一年級</option>
                                                    <option value="大學部|2">二年級</option>
                                                    <option value="大學部|3">三年級</option>
                                                    <option value="大學部|4">四年級</option>
                                                </optgroup>
                                                <optgroup label="碩士班">
                                                    <option value="碩士班|1">碩一</option>
                                                    <option value="碩士班|2">碩二</option>
                                                    <option value="碩士班|3">碩三</option>
                                                    <option value="碩士班|4">碩四</option>
                                                </optgroup>
                                                <optgroup label="博士班">
                                                    <option value="博士班|1">博一</option>
                                                    <option value="博士班|2">博二</option>
                                                    <option value="博士班|3">博三</option>
                                                    <option value="博士班|4">博四</option>
                                                </optgroup>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-bold text-primary small text-uppercase ls-1 mb-3">
                                        <span class="badge bg-primary rounded-pill me-1">3</span> 時間與偏好
                                    </label>

                                    <div class="form-check form-switch mb-3 d-flex align-items-center">
                                        <input class="form-check-input me-2" type="checkbox" id="check-empty-slots" checked style="cursor: pointer;">
                                        <label class="form-check-label pt-1" for="check-empty-slots" style="cursor: pointer;">只搜尋空堂時段</label>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label small text-muted mb-1">偏好星期</label>
                                        <div class="btn-group w-100" role="group">
                                            <input type="checkbox" class="btn-check day-filter" id="day-1" value="1" checked>
                                            <label class="btn btn-outline-secondary btn-sm" for="day-1">一</label>
                                            <input type="checkbox" class="btn-check day-filter" id="day-2" value="2" checked>
                                            <label class="btn btn-outline-secondary btn-sm" for="day-2">二</label>
                                            <input type="checkbox" class="btn-check day-filter" id="day-3" value="3" checked>
                                            <label class="btn btn-outline-secondary btn-sm" for="day-3">三</label>
                                            <input type="checkbox" class="btn-check day-filter" id="day-4" value="4" checked>
                                            <label class="btn btn-outline-secondary btn-sm" for="day-4">四</label>
                                            <input type="checkbox" class="btn-check day-filter" id="day-5" value="5" checked>
                                            <label class="btn btn-outline-secondary btn-sm" for="day-5">五</label>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="form-label small text-muted mb-1">目標學分</label>
                                        <input type="range" class="form-range" id="range-credits" min="1" max="40" value="27">
                                        <div class="text-end small text-muted"><span id="target-credits">27</span> 學分</div>
                                    </div>
                                </div>

                                <button id="btn-search-recommend" class="btn btn-primary w-100 py-2 fw-bold shadow-sm">
                                    <i class="fas fa-search me-2"></i> 開始推薦
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8">
                        <div id="recommend-results">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h3 class="h5 fw-bold mb-0">
                                    <i class="fas fa-list-ul text-primary me-2"></i>推薦結果
                                </h3>
                            </div>
                            <div id="recommend-courses-grid" class="row g-3">
                                <div class="col-12 text-center py-5 text-muted">
                                    <i class="fas fa-robot fa-3x mb-3 text-secondary opacity-25"></i>
                                    <p>請在左側設定條件並點擊「開始推薦」</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="tab-history" class="page-section d-none">
                <div class="mb-4">
                    <h2 class="h3 fw-bold mb-1">歷年課程資訊</h2>
                    <p class="text-muted mb-0">查詢過往開課紀錄、選課人數趨勢，知己知彼</p>
                </div>

                <div class="card shadow-sm mb-4 border-0">
                    <div class="card-body p-4">
                        <div class="input-group input-group-merged">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" id="search-history-input" class="form-control ps-0" placeholder="輸入課程名稱或教師姓名...">
                            <button id="btn-search-history" class="btn btn-primary px-4 fw-bold ms-2 rounded">
                                搜尋
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Cluster Analysis Section -->
                <div class="card shadow-sm mb-4 border-0" id="cluster-analysis-section">
                    <div class="card-header bg-transparent border-bottom pb-3">
                        <h5 class="mb-0 fw-bold">
                            <i class="fas fa-chart-pie me-2 text-primary"></i>
                            通識課程分群分析
                        </h5>
                        <p class="text-muted small mb-0 mt-1">基於選課行為（中籤率與飽和度）的 K-Means 分群結果</p>
                    </div>
                    <div class="card-body p-4">
                        <!-- 群組定義 -->
                        <div class="mb-4 pb-3 border-bottom">
                            <h6 class="fw-bold mb-3 text-primary">
                                <i class="fas fa-layer-group me-2"></i>群組定義
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-6 col-lg-3">
                                    <div class="p-3 rounded h-100" style="background: rgba(87, 124, 138, 0.08); ">
                                        <div class="fw-bold mb-1 d-flex align-items-center">
                                            <span class="badge bg-primary me-2" style="font-size: 0.7rem;">Cluster 0</span>
                                            <span>熱門超額</span>
                                        </div>
                                        <div class="small text-muted mt-2">競爭激烈，選上人數超過上限</div>
                                        <div class="small mt-2 fw-bold text-primary">138 門</div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-3">
                                    <div class="p-3 rounded h-100" style="background: rgba(87, 124, 138, 0.08);">
                                        <div class="fw-bold mb-1 d-flex align-items-center">
                                            <span class="badge bg-primary me-2" style="font-size: 0.7rem;">Cluster 1</span>
                                            <span>冷門未滿</span>
                                        </div>
                                        <div class="small text-muted mt-2">選課人數少，容易選上</div>
                                        <div class="small mt-2 fw-bold text-primary">68 門</div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-3">
                                    <div class="p-3 rounded h-100" style="background: rgba(87, 124, 138, 0.08); ">
                                        <div class="fw-bold mb-1 d-flex align-items-center">
                                            <span class="badge bg-primary me-2" style="font-size: 0.7rem;">Cluster 2</span>
                                            <span>特殊案例</span>
                                        </div>
                                        <div class="small text-muted mt-2">異常數據，需個別檢視</div>
                                        <div class="small mt-2 fw-bold text-primary">1 門</div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-3">
                                    <div class="p-3 rounded h-100" style="background: rgba(87, 124, 138, 0.08);">
                                        <div class="fw-bold mb-1 d-flex align-items-center">
                                            <span class="badge bg-primary me-2" style="font-size: 0.7rem;">Cluster 3</span>
                                            <span>一般熱門</span>
                                        </div>
                                        <div class="small text-muted mt-2">中籤率中等，接近滿額</div>
                                        <div class="small mt-2 fw-bold text-primary">204 門</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 圖表展示 -->
                        <div class="row g-4">
                            <!-- Chart 1: Scatter Plot -->
                            <div class="col-md-4">
                                <div class="text-center mb-2">
                                    <h6 class="fw-bold mb-1" style="font-size: 0.95rem;">選課行為分布</h6>
                                </div>
                                <div class="text-center mb-2">
                                    <img src="./assets/images/scatter_selection_vs_saturation.png" 
                                         alt="Selection Rate vs Saturation Scatter Plot" 
                                         class="img-fluid rounded shadow-sm cluster-chart-img"
                                         style="max-width: 100%; height: auto; cursor: pointer;"
                                         data-bs-toggle="modal"
                                         data-bs-target="#imageViewerModal"
                                         data-image-src="./assets/images/scatter_selection_vs_saturation.png"
                                         data-image-title="Selection Rate vs Saturation by Cluster"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <div style="display:none; padding: 2rem; background: #f8f9fa; border-radius: 8px; color: #6c757d;">
                                        <i class="fas fa-image fa-3x mb-3"></i>
                                        <p>圖片載入失敗，請檢查路徑</p>
                                    </div>
                                </div>
                                <p class="text-muted small mb-0 text-center" style="line-height: 1.5; font-size: 0.85rem;">
                                    展示各群組在中籤率與飽和度上的分布位置
                                </p>
                            </div>
                            
                            <!-- Chart 2: Cluster Distribution -->
                            <div class="col-md-4">
                                <div class="text-center mb-2">
                                    <h6 class="fw-bold mb-1" style="font-size: 0.95rem;">群組規模</h6>
                                </div>
                                <div class="text-center mb-2">
                                    <img src="./assets/images/cluster_distribution.png" 
                                         alt="Cluster Distribution Bar Chart" 
                                         class="img-fluid rounded shadow-sm cluster-chart-img"
                                         style="max-width: 100%; height: auto; cursor: pointer;"
                                         data-bs-toggle="modal"
                                         data-bs-target="#imageViewerModal"
                                         data-image-src="./assets/images/cluster_distribution.png"
                                         data-image-title="Cluster Distribution"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <div style="display:none; padding: 2rem; background: #f8f9fa; border-radius: 8px; color: #6c757d;">
                                        <i class="fas fa-image fa-3x mb-3"></i>
                                        <p>圖片載入失敗，請檢查路徑</p>
                                    </div>
                                </div>
                                <p class="text-muted small mb-0 text-center" style="line-height: 1.5; font-size: 0.85rem;">
                                    呈現各群組包含的課程數量
                                </p>
                            </div>
                            
                            <!-- Chart 3: Violin Plot -->
                            <div class="col-md-4">
                                <div class="text-center mb-2">
                                    <h6 class="fw-bold mb-1" style="font-size: 0.95rem;">統計分布</h6>
                                </div>
                                <div class="text-center mb-2">
                                    <img src="./assets/images/cluster_distribution_violin.png" 
                                         alt="Cluster Distribution Violin Plot" 
                                         class="img-fluid rounded shadow-sm cluster-chart-img"
                                         style="max-width: 100%; height: auto; cursor: pointer;"
                                         data-bs-toggle="modal"
                                         data-bs-target="#imageViewerModal"
                                         data-image-src="./assets/images/cluster_distribution_violin.png"
                                         data-image-title="Distribution by Cluster"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <div style="display:none; padding: 2rem; background: #f8f9fa; border-radius: 8px; color: #6c757d;">
                                        <i class="fas fa-image fa-3x mb-3"></i>
                                        <p>圖片載入失敗，請檢查路徑</p>
                                    </div>
                                </div>
                                <p class="text-muted small mb-0 text-center" style="line-height: 1.5; font-size: 0.85rem;">
                                    顯示各群組的數據集中趨勢與分散程度
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 fw-bold text-dark border-start border-4 border-primary ps-3" id="history-search-title">
                        搜尋結果
                    </h5>
                    <span class="badge bg-light text-dark border" id="history-result-count"></span>
                </div>

                <div id="history-results-container" class="row g-3">
                    <div class="col-12 text-center py-5">
                        <div class="text-muted opacity-50 mb-3">
                            <i class="fas fa-chart-bar fa-4x"></i>
                        </div>
                        <h5 class="text-muted fw-bold">等待搜尋</h5>
                        <p class="text-muted small">請在上列輸入關鍵字，探索課程歷史數據</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="sidebarBackdrop" class="sidebar-backdrop d-md-none" aria-hidden="true" onclick="toggleSidebar()"></div>

    <!-- Image Viewer Modal -->
    <div class="modal fade" id="imageViewerModal" tabindex="-1" aria-labelledby="imageViewerModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-dark border-0">
                <div class="modal-header border-0 p-0" style="position: absolute; top: 15px; right: 15px; z-index: 1055; background: transparent;">
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" style="font-size: 1.8rem; opacity: 1; filter: drop-shadow(0 0 3px rgba(0,0,0,0.5));"></button>
                </div>
                <div class="modal-body p-0 d-flex align-items-center justify-content-center" style="min-height: 100vh;">
                    <div class="text-center w-100 position-relative">
                        <h5 class="text-white mb-3 fw-bold" id="imageViewerModalTitle" style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1056; text-shadow: 0 2px 4px rgba(0,0,0,0.5);"></h5>
                        <img id="imageViewerModalImg" src="" alt="" class="img-fluid" style="max-width: 95%; max-height: 90vh; object-fit: contain; margin-top: 60px;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="courseDetailModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="courseDetailTitle">課程詳情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="courseDetailBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    <button type="button" class="btn btn-primary" id="btn-add-to-schedule">加入課表</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="historyDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-light">
                    <div>
                        <h5 class="modal-title fw-bold text-dark" id="historyDetailTitle">課程詳情</h5>
                        <p class="mb-0 text-muted small" id="historyDetailSubtitle">教師與科系資訊</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="card mb-4 border-0 shadow-sm">
                        <div class="card-body">
                            <h6 class="card-title fw-bold text-secondary mb-3">
                                <i class="fas fa-chart-line me-2"></i>歷年人數走勢
                            </h6>
                            <div style="height: 250px;">
                                <canvas id="historyDetailChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-0 overflow-hidden rounded-3">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0 align-middle">
                                    <tbody id="historyDetailTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="logicInfoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold text-dark">
                        <i class="fas fa-info-circle me-2 text-primary"></i>系統說明
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="d-flex flex-column gap-4">
                        
                        <div>
                            <h6 class="fw-bold text-dark mb-2">
                                <i class="fas fa-battery-half me-2 text-primary"></i>「飽和度」是什麼？
                            </h6>
                            <div class="bg-light p-3 rounded-3 border small text-secondary">
                                <p class="mb-2">代表這門課目前的<strong>額滿程度</strong>。</p>
                                <ul class="list-unstyled mb-0 d-flex flex-column gap-2">
                                    <li class="d-flex align-items-start">
                                        <span class="badge bg-secondary me-2 flex-shrink-0">公式</span>
                                        <span>目前選上人數 ÷ 上限人數</span>
                                    </li>
                                    <li class="d-flex align-items-center">
                                        <span class="badge bg-success me-2" style="width: 60px;">綠色</span>
                                        <span><strong>名額充足 (<80%)</strong>：位置還很多。</span>
                                    </li>
                                    <li class="d-flex align-items-center">
                                        <span class="badge bg-danger me-2" style="width: 60px;">紅色</span>
                                        <span><strong>已額滿 (≥100%)</strong>：需排候補或加簽。</span>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div>
                            <h6 class="fw-bold text-dark mb-2">
                                <i class="fas fa-chart-pie me-2 text-success"></i>「中籤率 (選上率)」是什麼？
                            </h6>
                            <div class="bg-light p-3 rounded-3 border small text-secondary">
                                <p class="mb-2">這是根據<strong>歷年數據</strong>估算的<strong>選中機率</strong>。</p>
                                <ul class="list-unstyled mb-0 d-flex flex-column gap-2">
                                    <li class="d-flex align-items-start">
                                        <span class="badge bg-primary me-2 flex-shrink-0">公式</span>
                                        <span><strong>上限人數 ÷ 登記人數</strong> (若登記人數少於上限，則為 100%)。</span>
                                    </li>
                                    <li class="d-flex align-items-start">
                                        <i class="fas fa-info-circle text-primary me-2 mt-1"></i>
                                        <span>數字越低代表越難選上 (例如 30% 代表 10 人搶 3 個位置)。</span>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div>
                            <h6 class="fw-bold text-dark mb-2">
                                <i class="far fa-lightbulb me-2 text-warning"></i>選課小撇步
                            </h6>
                            <p class="small text-muted mb-0 lh-base">
                                如果看到中籤率<strong>低於 50%</strong> (紅色)，代表這門課非常搶手！<br>
                                建議您：
                                <span class="d-block mt-1 ps-3 border-start border-3 border-danger">
                                    1. 在志願序中把它<strong>排前面一點</strong>。<br>
                                    2. 務必多找幾個<strong>備用的課程</strong>。
                                </span>
                            </p>
                        </div>

                    </div>
                </div>
                <div class="modal-footer bg-light border-0 p-2">
                    <button type="button" class="btn btn-sm btn-secondary w-100 rounded-pill" data-bs-dismiss="modal">我知道了</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-bottom-0 pb-0">
                    <h5 class="modal-title fw-bold">
                        <i class="fas fa-sliders-h me-2 text-primary"></i>系統設定
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-4">
                        <label class="form-label fw-bold text-secondary small text-uppercase ls-1 mb-3">介面主題</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="radio" class="btn-check" name="theme-options" id="theme-light" value="light" checked>
                                <label class="btn btn-outline-secondary w-100 d-flex align-items-center justify-content-center gap-2 py-2" for="theme-light">
                                    <i class="fas fa-sun"></i> 亮色模式
                                </label>
                            </div>
                            <div class="col-6">
                                <input type="radio" class="btn-check" name="theme-options" id="theme-dark" value="dark">
                                <label class="btn btn-outline-secondary w-100 d-flex align-items-center justify-content-center gap-2 py-2" for="theme-dark">
                                    <i class="fas fa-moon"></i> 深色模式
                                </label>
                            </div>
                        </div>
                    </div>
    
                    <div class="mb-4">
                        <label class="form-label fw-bold text-secondary small text-uppercase ls-1 mb-3">課表預設檢視</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="radio" class="btn-check" name="view-options" id="view-table" value="table" checked>
                                <label class="btn btn-outline-secondary w-100 d-flex align-items-center justify-content-center gap-2 py-2" for="view-table">
                                    <i class="fas fa-table"></i> 表格檢視
                                </label>
                            </div>
                            <div class="col-6">
                                <input type="radio" class="btn-check" name="view-options" id="view-cards" value="cards">
                                <label class="btn btn-outline-secondary w-100 d-flex align-items-center justify-content-center gap-2 py-2" for="view-cards">
                                    <i class="fas fa-th-large"></i> 卡片檢視
                                </label>
                            </div>
                        </div>
                    </div>
    
                    <div class="pt-3 border-top">
                        <label class="form-label fw-bold text-danger small text-uppercase ls-1 mb-3">進階操作</label>
                        <button id="btn-reset-app" class="btn btn-outline-danger w-100 text-start">
                            <i class="fas fa-exclamation-triangle me-2"></i> 重置所有資料 (清除快取)
                        </button>
                        <div class="form-text mt-2 small">這將清除所有已選課程與設定，還原至初始狀態。</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- Image Viewer Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const imageViewerModal = document.getElementById('imageViewerModal');
            const modalImg = document.getElementById('imageViewerModalImg');
            const modalTitle = document.getElementById('imageViewerModalTitle');
            
            if (!imageViewerModal || !modalImg) {
                console.error('Image viewer modal elements not found');
                return;
            }
            
            let bsModalInstance = null;
            
            // 使用 Bootstrap 5 的事件监听方式
            imageViewerModal.addEventListener('show.bs.modal', function(event) {
                // 修复 aria-hidden 警告
                imageViewerModal.setAttribute('aria-hidden', 'false');
                
                // 获取触发模态框的图片元素
                const triggerImg = event.relatedTarget || document.querySelector('.cluster-chart-img:focus');
                
                if (triggerImg) {
                    const imageSrc = triggerImg.getAttribute('data-image-src') || triggerImg.src;
                    const imageTitle = triggerImg.getAttribute('data-image-title') || triggerImg.alt;
                    
                    if (imageSrc && modalImg) {
                        modalImg.src = imageSrc;
                        modalImg.alt = imageTitle || 'Chart Image';
                        if (modalTitle) {
                            modalTitle.textContent = imageTitle || '';
                        }
                    }
                }
            });
            
            // 模态框完全隐藏后的事件
            imageViewerModal.addEventListener('hidden.bs.modal', function(event) {
                // 确保 aria-hidden 恢复
                imageViewerModal.setAttribute('aria-hidden', 'true');
                
                // 强制移除可能残留的 backdrop
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(function(backdrop) {
                    backdrop.remove();
                });
                
                // 移除 body 上的 modal-open class
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            });
            
            // 處理所有圖片的點擊事件
            document.querySelectorAll('.cluster-chart-img').forEach(function(img) {
                img.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const imageSrc = this.getAttribute('data-image-src') || this.src;
                    const imageTitle = this.getAttribute('data-image-title') || this.alt;
                    
                    if (imageSrc && modalImg) {
                        modalImg.src = imageSrc;
                        modalImg.alt = imageTitle || 'Chart Image';
                        if (modalTitle) {
                            modalTitle.textContent = imageTitle || '';
                        }
                        
                        // 使用 Bootstrap 5 的方式显示模态框
                        if (!bsModalInstance) {
                            bsModalInstance = new bootstrap.Modal(imageViewerModal, {
                                backdrop: true,
                                keyboard: true
                            });
                        }
                        bsModalInstance.show();
                    }
                });
            });
            
            // ESC 鍵關閉
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && bsModalInstance) {
                    const isShown = imageViewerModal.classList.contains('show');
                    if (isShown) {
                        bsModalInstance.hide();
                    }
                }
            });
        });
    </script>
    
    <script type="module" src="js/main.js"></script>
</body>
</html>